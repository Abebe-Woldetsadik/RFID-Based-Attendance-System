{% extends "base.html" %}
{% block title %}Live Scan{% endblock %}

{% block content %}
<h2>Live Scan</h2>

<div id="status-message" class="alert alert-info">Waiting for scan...</div>

<table class="table table-striped">
    <thead>
        <tr>
            <th>Username</th>
            <th>First Name</th>
            <th>Last Name</th>
            <th>Timestamp</th>
            <th>Status</th>
        </tr>
    </thead>
    <tbody id="attendance-table-body">
        {% for record in attendances %}
        <tr id="row-{{ record.id }}">
            <td>{% if record.user %}{{ record.user.username }}{% else %}Unknown{% endif %}</td>
            <td>{% if record.user %}{{ record.user.first_name }}{% else %}-{% endif %}</td>
            <td>{% if record.user %}{{ record.user.last_name }}{% else %}-{% endif %}</td>
            <td>{{ record.timestamp }}</td>
            <td>{{ record.status }}</td>
        </tr>
        {% endfor %}
    </tbody>
</table>

<script>
function fetchLiveStatus() {
    fetch("{% url 'live_status_json' %}")
        .then(res => res.json())
        .then(data => {
            // Update status message
            const msgDiv = document.getElementById('status-message');
            msgDiv.textContent = data.status_message;

            // Update alert class
            msgDiv.className = "alert " + (
                data.status_type === "success" ? "alert-success" :
                data.status_type === "warning" ? "alert-danger" :
                data.status_type === "error" ? "alert-warning" :
                "alert-info"
            );

            // Update table
            const tbody = document.getElementById('attendance-table-body');
            tbody.innerHTML = "";
            data.records.forEach(r => {
                tbody.innerHTML += `<tr>
                    <td>${r.username}</td>
                    <td>${r.first_name}</td>
                    <td>${r.last_name}</td>
                    <td>${r.timestamp}</td>
                    <td>${r.status}</td>
                </tr>`;
            });
        });
}

// Refresh every 3 seconds
setInterval(fetchLiveStatus, 3000);
</script>
{% endblock %}
